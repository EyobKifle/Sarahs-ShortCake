<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Enhanced Reports - Sarah's Shortcakes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .log-container {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }
        .log-entry {
            margin-bottom: 0.5rem;
            padding: 0.25rem 0;
        }
        .log-success { color: #198754; }
        .log-error { color: #dc3545; }
        .log-info { color: #0d6efd; }
        .log-warning { color: #fd7e14; }
    </style>
</head>
<body class="bg-light">
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <h2><i class="fas fa-flask me-2"></i>Enhanced Reports Test Suite</h2>
                <p class="text-muted">Testing live database connectivity and export functionality</p>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-users me-2"></i>Customer Reports Test</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="testCustomerReports()">
                                <i class="fas fa-play me-1"></i>Test Customer Reports
                            </button>
                            <button class="btn btn-success" onclick="testCustomerExport()">
                                <i class="fas fa-download me-1"></i>Test Customer Export
                            </button>
                            <a href="/customer-reports.html" class="btn btn-outline-primary">
                                <i class="fas fa-external-link-alt me-1"></i>Open Customer Reports
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-boxes me-2"></i>Inventory Reports Test</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="testInventoryReports()">
                                <i class="fas fa-play me-1"></i>Test Inventory Reports
                            </button>
                            <button class="btn btn-success" onclick="testInventoryExport()">
                                <i class="fas fa-download me-1"></i>Test Inventory Export
                            </button>
                            <a href="/inventory-reports.html" class="btn btn-outline-primary">
                                <i class="fas fa-external-link-alt me-1"></i>Open Inventory Reports
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-terminal me-2"></i>Test Results</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearLog()">
                            <i class="fas fa-trash me-1"></i>Clear Log
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="logContainer" class="log-container">
                            <div class="log-entry log-info">üîÑ Ready to run tests...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle me-2"></i>Test Information</h5>
                    </div>
                    <div class="card-body">
                        <h6>What these tests verify:</h6>
                        <ul>
                            <li><strong>Live Database Connectivity:</strong> Tests fetch real data from MongoDB</li>
                            <li><strong>API Response Structure:</strong> Verifies correct data format</li>
                            <li><strong>Export Functionality:</strong> Tests CSV export generation</li>
                            <li><strong>Error Handling:</strong> Checks for proper error responses</li>
                            <li><strong>Data Completeness:</strong> Ensures all required fields are present</li>
                        </ul>
                        
                        <h6 class="mt-3">Expected Results:</h6>
                        <ul>
                            <li>‚úÖ API calls return status 200</li>
                            <li>‚úÖ Data contains summary statistics</li>
                            <li>‚úÖ Items/customers arrays are populated</li>
                            <li>‚úÖ Export generates downloadable CSV files</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script src="/js/api-client.js"></script>

    <script>
        // Initialize API client
        window.apiClient = new ApiClient();

        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLog() {
            document.getElementById('logContainer').innerHTML = '<div class="log-entry log-info">üîÑ Log cleared...</div>';
        }

        async function testCustomerReports() {
            log('üß™ Starting Customer Reports Test...', 'info');
            
            try {
                // Test basic customer report
                log('üì° Fetching customer report data...', 'info');
                const response = await window.apiClient.getCustomerReport();
                
                if (!response) {
                    throw new Error('No response received');
                }

                log(`‚úÖ API Response received (Status: ${response.success ? 'Success' : 'Failed'})`, 'success');
                
                if (response.data) {
                    const data = response.data;
                    log(`üìä Summary: ${data.summary?.totalCustomers || 0} customers, $${data.summary?.totalRevenue?.toFixed(2) || '0.00'} revenue`, 'success');
                    log(`üë• Customer records: ${data.customers?.length || 0} items`, 'success');
                    log(`üèÜ Top customers: ${data.topCustomers?.length || 0} items`, 'success');
                    
                    // Test with filters
                    log('üîç Testing with filters...', 'info');
                    const filteredResponse = await window.apiClient.getCustomerReport('segment=all&sortBy=totalSpent&orderBy=desc');
                    log(`‚úÖ Filtered response: ${filteredResponse.data?.customers?.length || 0} customers`, 'success');
                } else {
                    log('‚ö†Ô∏è No data in response', 'warning');
                }

                log('‚úÖ Customer Reports Test PASSED', 'success');
            } catch (error) {
                log(`‚ùå Customer Reports Test FAILED: ${error.message}`, 'error');
                console.error('Customer reports test error:', error);
            }
        }

        async function testInventoryReports() {
            log('üß™ Starting Inventory Reports Test...', 'info');
            
            try {
                // Test basic inventory report
                log('üì° Fetching inventory report data...', 'info');
                const response = await window.apiClient.getInventoryReport();
                
                if (!response) {
                    throw new Error('No response received');
                }

                log(`‚úÖ API Response received (Status: ${response.success ? 'Success' : 'Failed'})`, 'success');
                
                if (response.data) {
                    const data = response.data;
                    log(`üì¶ Summary: ${data.summary?.totalItems || 0} items, $${data.summary?.totalValue?.toFixed(2) || '0.00'} value`, 'success');
                    log(`üìã Inventory records: ${data.items?.length || 0} items`, 'success');
                    log(`üìÇ Categories: ${Object.keys(data.categories || {}).length} categories`, 'success');
                    
                    // Test with filters
                    log('üîç Testing with filters...', 'info');
                    const filteredResponse = await window.apiClient.getInventoryReport('category=all&status=all&sortBy=name');
                    log(`‚úÖ Filtered response: ${filteredResponse.data?.items?.length || 0} items`, 'success');
                } else {
                    log('‚ö†Ô∏è No data in response', 'warning');
                }

                log('‚úÖ Inventory Reports Test PASSED', 'success');
            } catch (error) {
                log(`‚ùå Inventory Reports Test FAILED: ${error.message}`, 'error');
                console.error('Inventory reports test error:', error);
            }
        }

        async function testCustomerExport() {
            log('üß™ Testing Customer Export...', 'info');
            
            try {
                const response = await window.apiClient.getCustomerReport();
                
                if (response && response.data && response.data.customers) {
                    // Simulate export functionality
                    const headers = ['Name', 'Email', 'Order Count', 'Total Spent'];
                    const csvContent = [
                        headers.join(','),
                        ...response.data.customers.slice(0, 5).map(customer => [
                            `"${customer.name}"`,
                            `"${customer.email}"`,
                            customer.orderCount,
                            customer.totalSpent.toFixed(2)
                        ].join(','))
                    ].join('\n');

                    log(`üìÑ CSV Content generated (${csvContent.split('\n').length - 1} data rows)`, 'success');
                    log('‚úÖ Customer Export Test PASSED', 'success');
                } else {
                    throw new Error('No customer data available for export');
                }
            } catch (error) {
                log(`‚ùå Customer Export Test FAILED: ${error.message}`, 'error');
            }
        }

        async function testInventoryExport() {
            log('üß™ Testing Inventory Export...', 'info');
            
            try {
                const response = await window.apiClient.getInventoryReport();
                
                if (response && response.data && response.data.items) {
                    // Simulate export functionality
                    const headers = ['Name', 'Category', 'Quantity', 'Status', 'Value'];
                    const csvContent = [
                        headers.join(','),
                        ...response.data.items.slice(0, 5).map(item => [
                            `"${item.name}"`,
                            `"${item.category}"`,
                            item.quantity,
                            `"${item.status}"`,
                            item.totalValue.toFixed(2)
                        ].join(','))
                    ].join('\n');

                    log(`üìÑ CSV Content generated (${csvContent.split('\n').length - 1} data rows)`, 'success');
                    log('‚úÖ Inventory Export Test PASSED', 'success');
                } else {
                    throw new Error('No inventory data available for export');
                }
            } catch (error) {
                log(`‚ùå Inventory Export Test FAILED: ${error.message}`, 'error');
            }
        }

        // Auto-run basic connectivity test on page load
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Enhanced Reports Test Suite Loaded', 'info');
            log('üí° Click the test buttons above to verify functionality', 'info');
        });
    </script>
</body>
</html>
