<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Notifications Test - Sarah's Short Cakes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .test-card {
            transition: all 0.3s ease;
            border-left: 4px solid #007bff;
        }
        .test-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        .test-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .email-preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-top: 10px;
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1><i class="fas fa-envelope text-primary"></i> Email Notifications Test Center</h1>
                    <div>
                        <button class="btn btn-success" onclick="runAllTests()">
                            <i class="fas fa-play"></i> Run All Tests
                        </button>
                        <a href="/admin-settings.html" class="btn btn-outline-primary">
                            <i class="fas fa-cog"></i> Email Settings
                        </a>
                    </div>
                </div>

                <!-- Test Results Summary -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <h3 id="totalTests">0</h3>
                                <p class="mb-0">Total Tests</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h3 id="passedTests">0</h3>
                                <p class="mb-0">Passed</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-danger text-white">
                            <div class="card-body text-center">
                                <h3 id="failedTests">0</h3>
                                <p class="mb-0">Failed</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <h3 id="testProgress">0%</h3>
                                <p class="mb-0">Progress</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Customer Email Tests -->
                <div class="row">
                    <div class="col-lg-6">
                        <h3><i class="fas fa-user text-info"></i> Customer Email Tests</h3>

                        <!-- Order Confirmation Test -->
                        <div class="card test-card mb-3">
                            <div class="card-header">
                                <h5><i class="fas fa-shopping-cart"></i> Order Confirmation Email</h5>
                            </div>
                            <div class="card-body">
                                <p>Tests email sent to customers when they place a new order.</p>
                                <div class="mb-3">
                                    <label class="form-label">Test Email:</label>
                                    <input type="email" class="form-control" id="customerEmail" placeholder="customer@example.com">
                                </div>
                                <button class="btn btn-primary" onclick="testOrderConfirmation()">
                                    <i class="fas fa-paper-plane"></i> Test Order Confirmation
                                </button>
                                <div id="orderConfirmationResult"></div>
                            </div>
                        </div>

                        <!-- Order Status Update Test -->
                        <div class="card test-card mb-3">
                            <div class="card-header">
                                <h5><i class="fas fa-sync-alt"></i> Order Status Update Email</h5>
                            </div>
                            <div class="card-body">
                                <p>Tests email sent when order status changes.</p>
                                <div class="mb-3">
                                    <label class="form-label">New Status:</label>
                                    <select class="form-control" id="orderStatus">
                                        <option value="confirmed">Confirmed</option>
                                        <option value="processing">Processing</option>
                                        <option value="completed">Completed</option>
                                        <option value="cancelled">Cancelled</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary" onclick="testOrderStatusUpdate()">
                                    <i class="fas fa-paper-plane"></i> Test Status Update
                                </button>
                                <div id="orderStatusResult"></div>
                            </div>
                        </div>

                        <!-- Welcome Email Test -->
                        <div class="card test-card mb-3">
                            <div class="card-header">
                                <h5><i class="fas fa-heart"></i> Welcome Email</h5>
                            </div>
                            <div class="card-body">
                                <p>Tests welcome email sent to new customers.</p>
                                <button class="btn btn-primary" onclick="testWelcomeEmail()">
                                    <i class="fas fa-paper-plane"></i> Test Welcome Email
                                </button>
                                <div id="welcomeEmailResult"></div>
                            </div>
                        </div>

                        <!-- Password Reset Test -->
                        <div class="card test-card mb-3">
                            <div class="card-header">
                                <h5><i class="fas fa-key"></i> Password Reset Email</h5>
                            </div>
                            <div class="card-body">
                                <p>Tests password reset email functionality.</p>
                                <button class="btn btn-primary" onclick="testPasswordReset()">
                                    <i class="fas fa-paper-plane"></i> Test Password Reset
                                </button>
                                <div id="passwordResetResult"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Admin Email Tests -->
                    <div class="col-lg-6">
                        <h3><i class="fas fa-user-shield text-warning"></i> Admin Email Tests</h3>

                        <!-- New Order Alert Test -->
                        <div class="card test-card mb-3">
                            <div class="card-header">
                                <h5><i class="fas fa-bell"></i> New Order Alert</h5>
                            </div>
                            <div class="card-body">
                                <p>Tests alert email sent to admin when new orders are placed.</p>
                                <button class="btn btn-warning" onclick="testNewOrderAlert()">
                                    <i class="fas fa-paper-plane"></i> Test New Order Alert
                                </button>
                                <div id="newOrderAlertResult"></div>
                            </div>
                        </div>

                        <!-- Low Stock Alert Test -->
                        <div class="card test-card mb-3">
                            <div class="card-header">
                                <h5><i class="fas fa-exclamation-triangle"></i> Low Stock Alert</h5>
                            </div>
                            <div class="card-body">
                                <p>Tests low stock alert email sent to admin.</p>
                                <button class="btn btn-warning" onclick="testLowStockAlert()">
                                    <i class="fas fa-paper-plane"></i> Test Low Stock Alert
                                </button>
                                <div id="lowStockAlertResult"></div>
                            </div>
                        </div>

                        <!-- System Alert Test -->
                        <div class="card test-card mb-3">
                            <div class="card-header">
                                <h5><i class="fas fa-server"></i> System Alert</h5>
                            </div>
                            <div class="card-body">
                                <p>Tests system alert emails for critical issues.</p>
                                <button class="btn btn-warning" onclick="testSystemAlert()">
                                    <i class="fas fa-paper-plane"></i> Test System Alert
                                </button>
                                <div id="systemAlertResult"></div>
                            </div>
                        </div>

                        <!-- Daily Report Test -->
                        <div class="card test-card mb-3">
                            <div class="card-header">
                                <h5><i class="fas fa-chart-bar"></i> Daily Report Email</h5>
                            </div>
                            <div class="card-body">
                                <p>Tests daily business report email.</p>
                                <button class="btn btn-warning" onclick="testDailyReport()">
                                    <i class="fas fa-paper-plane"></i> Test Daily Report
                                </button>
                                <div id="dailyReportResult"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Email Configuration Status -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-cog"></i> Email Configuration Status</h5>
                            </div>
                            <div class="card-body">
                                <div id="emailConfigStatus">
                                    <p class="text-muted">Loading email configuration...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/api-client.js"></script>
    <script>
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadEmailConfiguration();
            document.getElementById('customerEmail').value = 'test@example.com';
        });

        // Update test statistics
        function updateTestStats() {
            document.getElementById('totalTests').textContent = testResults.total;
            document.getElementById('passedTests').textContent = testResults.passed;
            document.getElementById('failedTests').textContent = testResults.failed;
            const progress = testResults.total > 0 ? Math.round((testResults.passed / testResults.total) * 100) : 0;
            document.getElementById('testProgress').textContent = progress + '%';
        }

        // Show test result
        function showTestResult(elementId, success, message, details = '') {
            const element = document.getElementById(elementId);
            const resultClass = success ? 'test-success' : 'test-error';
            const icon = success ? 'fas fa-check-circle' : 'fas fa-times-circle';

            element.innerHTML = `
                <div class="test-result ${resultClass}">
                    <i class="${icon}"></i> ${message}
                    ${details ? `<div class="mt-2"><small>${details}</small></div>` : ''}
                </div>
            `;

            testResults.total++;
            if (success) testResults.passed++;
            else testResults.failed++;
            updateTestStats();
        }

        // Test order confirmation email
        async function testOrderConfirmation() {
            const email = document.getElementById('customerEmail').value;
            if (!email) {
                showTestResult('orderConfirmationResult', false, 'Please enter a test email address');
                return;
            }

            try {
                showTestResult('orderConfirmationResult', null, 'Sending test order confirmation...', '');

                const response = await fetch('/api/test/order-confirmation-registered', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify({ testEmail: email })
                });

                const result = await response.json();

                if (result.success) {
                    showTestResult('orderConfirmationResult', true, 'Order confirmation email sent successfully!',
                        `Sent to: ${email}<br>Order ID: ${result.data?.orderId || 'N/A'}`);
                } else {
                    showTestResult('orderConfirmationResult', false, 'Failed to send order confirmation', result.message);
                }
            } catch (error) {
                showTestResult('orderConfirmationResult', false, 'Error sending order confirmation', error.message);
            }
        }

        // Test order status update email
        async function testOrderStatusUpdate() {
            const email = document.getElementById('customerEmail').value;
            const status = document.getElementById('orderStatus').value;

            if (!email) {
                showTestResult('orderStatusResult', false, 'Please enter a test email address');
                return;
            }

            try {
                showTestResult('orderStatusResult', null, 'Sending test status update...', '');

                const response = await fetch('/api/test/order-status-update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify({
                        testEmail: email,
                        newStatus: status,
                        customerType: 'registered'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showTestResult('orderStatusResult', true, 'Order status update email sent successfully!',
                        `Status: ${status}<br>Sent to: ${email}`);
                } else {
                    showTestResult('orderStatusResult', false, 'Failed to send status update', result.message);
                }
            } catch (error) {
                showTestResult('orderStatusResult', false, 'Error sending status update', error.message);
            }
        }

        // Test welcome email
        async function testWelcomeEmail() {
            try {
                showTestResult('welcomeEmailResult', null, 'Sending test welcome email...', '');

                const response = await fetch('/api/test/welcome-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showTestResult('welcomeEmailResult', true, 'Welcome email sent successfully!',
                        `Sent to: ${result.data?.customerEmail || 'Test customer'}`);
                } else {
                    showTestResult('welcomeEmailResult', false, 'Failed to send welcome email', result.message);
                }
            } catch (error) {
                showTestResult('welcomeEmailResult', false, 'Error sending welcome email', error.message);
            }
        }

        // Test password reset email
        async function testPasswordReset() {
            const email = document.getElementById('customerEmail').value;
            if (!email) {
                showTestResult('passwordResetResult', false, 'Please enter a test email address');
                return;
            }

            try {
                showTestResult('passwordResetResult', null, 'Sending test password reset...', '');

                const response = await fetch('/api/test/password-reset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify({ testEmail: email })
                });

                const result = await response.json();

                if (result.success) {
                    showTestResult('passwordResetResult', true, 'Password reset email sent successfully!',
                        `Sent to: ${email}`);
                } else {
                    showTestResult('passwordResetResult', false, 'Failed to send password reset', result.message);
                }
            } catch (error) {
                showTestResult('passwordResetResult', false, 'Error sending password reset', error.message);
            }
        }

        // Test new order alert
        async function testNewOrderAlert() {
            try {
                showTestResult('newOrderAlertResult', null, 'Sending test new order alert...', '');

                const response = await fetch('/api/test/new-order-alert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showTestResult('newOrderAlertResult', true, 'New order alert sent successfully!',
                        `Order ID: ${result.data?.orderId || 'N/A'}<br>Customer: ${result.data?.customerName || 'Test Customer'}`);
                } else {
                    showTestResult('newOrderAlertResult', false, 'Failed to send new order alert', result.message);
                }
            } catch (error) {
                showTestResult('newOrderAlertResult', false, 'Error sending new order alert', error.message);
            }
        }

        // Test low stock alert
        async function testLowStockAlert() {
            try {
                showTestResult('lowStockAlertResult', null, 'Sending test low stock alert...', '');

                const response = await fetch('/api/test/low-stock-alert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showTestResult('lowStockAlertResult', true, 'Low stock alert sent successfully!',
                        `Items checked: ${result.data?.itemsCount || 'N/A'}`);
                } else {
                    showTestResult('lowStockAlertResult', false, 'Failed to send low stock alert', result.message);
                }
            } catch (error) {
                showTestResult('lowStockAlertResult', false, 'Error sending low stock alert', error.message);
            }
        }

        // Test system alert
        async function testSystemAlert() {
            try {
                showTestResult('systemAlertResult', null, 'Sending test system alert...', '');

                // Simulate system alert
                const response = await fetch('/api/settings/test-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify({
                        testEmail: 'admin@sarahsshortcakes.com',
                        emailSettings: {
                            smtpHost: 'smtp.gmail.com',
                            smtpPort: 587,
                            smtpUser: 'test@gmail.com',
                            smtpPassword: 'test',
                            fromEmail: 'test@gmail.com',
                            fromName: "Sarah's Short Cakes",
                            useSSL: true
                        }
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showTestResult('systemAlertResult', true, 'System alert test completed!',
                        'Email configuration test executed successfully');
                } else {
                    showTestResult('systemAlertResult', false, 'System alert test failed', result.message);
                }
            } catch (error) {
                showTestResult('systemAlertResult', false, 'Error testing system alert', error.message);
            }
        }

        // Test daily report
        async function testDailyReport() {
            try {
                showTestResult('dailyReportResult', null, 'Generating test daily report...', '');

                const response = await fetch('/api/test/comprehensive', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showTestResult('dailyReportResult', true, 'Daily report test completed!',
                        `Tests run: ${result.results?.summary?.total || 0}<br>Passed: ${result.results?.summary?.passed || 0}`);
                } else {
                    showTestResult('dailyReportResult', false, 'Daily report test failed', result.message);
                }
            } catch (error) {
                showTestResult('dailyReportResult', false, 'Error testing daily report', error.message);
            }
        }

        // Run all tests
        async function runAllTests() {
            // Reset test results
            testResults = { total: 0, passed: 0, failed: 0 };
            updateTestStats();

            // Clear all previous results
            const resultElements = [
                'orderConfirmationResult', 'orderStatusResult', 'welcomeEmailResult',
                'passwordResetResult', 'newOrderAlertResult', 'lowStockAlertResult',
                'systemAlertResult', 'dailyReportResult'
            ];

            resultElements.forEach(id => {
                document.getElementById(id).innerHTML = '';
            });

            // Run tests with delays
            await testOrderConfirmation();
            await new Promise(resolve => setTimeout(resolve, 1000));

            await testOrderStatusUpdate();
            await new Promise(resolve => setTimeout(resolve, 1000));

            await testWelcomeEmail();
            await new Promise(resolve => setTimeout(resolve, 1000));

            await testPasswordReset();
            await new Promise(resolve => setTimeout(resolve, 1000));

            await testNewOrderAlert();
            await new Promise(resolve => setTimeout(resolve, 1000));

            await testLowStockAlert();
            await new Promise(resolve => setTimeout(resolve, 1000));

            await testSystemAlert();
            await new Promise(resolve => setTimeout(resolve, 1000));

            await testDailyReport();

            // Show completion message
            setTimeout(() => {
                alert(`All tests completed!\nTotal: ${testResults.total}\nPassed: ${testResults.passed}\nFailed: ${testResults.failed}`);
            }, 1000);
        }

        // Load email configuration status
        async function loadEmailConfiguration() {
            try {
                const response = await apiClient.get('/api/settings');
                const settings = response.data;

                let configHtml = '<div class="row">';

                // SMTP Configuration
                configHtml += `
                    <div class="col-md-6">
                        <h6>SMTP Configuration</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-server"></i> Host: ${settings.emailSettings?.smtpHost || 'Not configured'}</li>
                            <li><i class="fas fa-plug"></i> Port: ${settings.emailSettings?.smtpPort || 'Not configured'}</li>
                            <li><i class="fas fa-user"></i> Username: ${settings.emailSettings?.smtpUser || 'Not configured'}</li>
                            <li><i class="fas fa-shield-alt"></i> SSL: ${settings.emailSettings?.useSSL ? 'Enabled' : 'Disabled'}</li>
                        </ul>
                    </div>
                `;

                // Notification Settings
                configHtml += `
                    <div class="col-md-6">
                        <h6>Notification Settings</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-envelope"></i> Email Notifications: ${settings.notificationSettings?.emailNotifications ? 'Enabled' : 'Disabled'}</li>
                            <li><i class="fas fa-bell"></i> New Order Alerts: ${settings.notificationSettings?.newOrderAlerts ? 'Enabled' : 'Disabled'}</li>
                            <li><i class="fas fa-exclamation-triangle"></i> Low Stock Alerts: ${settings.notificationSettings?.lowStockAlerts ? 'Enabled' : 'Disabled'}</li>
                        </ul>
                    </div>
                `;

                configHtml += '</div>';

                document.getElementById('emailConfigStatus').innerHTML = configHtml;
            } catch (error) {
                document.getElementById('emailConfigStatus').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> Error loading email configuration: ${error.message}
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
