<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Inventory Management Features</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">
            <i class="fas fa-boxes text-primary me-2"></i>
            Inventory Management Test
        </h1>

        <!-- Test Controls -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Test Controls</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <button class="btn btn-primary w-100" onclick="testLoadInventory()">
                                    <i class="fas fa-sync me-1"></i> Load Inventory
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-success w-100" onclick="testCreateItem()">
                                    <i class="fas fa-plus me-1"></i> Create Test Item
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-info w-100" onclick="testRestock()">
                                    <i class="fas fa-arrow-up me-1"></i> Test Restock
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-warning w-100" onclick="testHistory()">
                                    <i class="fas fa-history me-1"></i> Test History
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Display -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Test Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="testResults">
                            <p class="text-muted">Click a test button to see results...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory Table -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Current Inventory</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped" id="inventoryTable">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Category</th>
                                        <th>Quantity</th>
                                        <th>Unit</th>
                                        <th>Threshold</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="inventoryTableBody">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">
                                            No inventory loaded. Click "Load Inventory" to fetch data.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- API Client -->
    <script src="js/api-client.js"></script>

    <!-- Inventory Management Module -->
    <script src="js/modules/inventory-management.js"></script>

    <script>
        let currentInventory = [];
        let testItemId = null;

        // Check authentication status
        async function checkAuth() {
            try {
                const token = localStorage.getItem('token') || getCookie('jwt');
                if (!token) {
                    showResult('⚠️ No authentication token found. Please login as admin first.', 'warning');
                    return false;
                }

                // Try to make a simple API call to verify auth
                const response = await fetch('/api/admin/auth/check', {
                    credentials: 'include',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    showResult(`✅ Authenticated as: ${data.user?.firstName} ${data.user?.lastName} (${data.user?.role})`, 'success');
                    return true;
                } else {
                    showResult('❌ Authentication failed. Please login as admin.', 'danger');
                    return false;
                }
            } catch (error) {
                showResult(`❌ Auth check failed: ${error.message}`, 'danger');
                return false;
            }
        }

        // Helper function to get cookie value
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // Test Functions
        async function testLoadInventory() {
            try {
                showResult('Checking authentication...', 'info');

                const isAuth = await checkAuth();
                if (!isAuth) {
                    showResult('❌ Please login as admin first. Redirecting to login...', 'danger');
                    setTimeout(() => {
                        window.location.href = '/login.html';
                    }, 2000);
                    return;
                }

                showResult('Loading inventory...', 'info');

                const response = await window.apiClient.getAllInventoryItems();
                console.log('API Response:', response);

                currentInventory = response.data || response || [];

                showResult(`✅ Successfully loaded ${currentInventory.length} inventory items`, 'success');
                renderInventoryTable();

            } catch (error) {
                console.error('Error details:', error);
                showResult(`❌ Error loading inventory: ${error.message}`, 'danger');
            }
        }

        async function testCreateItem() {
            try {
                showResult('Creating test inventory item...', 'info');

                const testItem = {
                    name: `Test Item ${Date.now()}`,
                    category: 'Other',
                    description: 'Test item for inventory management',
                    quantity: 100,
                    unit: 'pieces',
                    threshold: 10,
                    costPerUnit: 5.99,
                    location: 'Test Storage',
                    supplier: 'Test Supplier'
                };

                const response = await window.apiClient.createInventoryItem(testItem);

                if (response.success) {
                    testItemId = response.data._id;
                    showResult(`✅ Successfully created test item: ${response.data.name} (ID: ${testItemId})`, 'success');
                    testLoadInventory(); // Refresh the table
                } else {
                    throw new Error(response.message || 'Failed to create item');
                }

            } catch (error) {
                showResult(`❌ Error creating test item: ${error.message}`, 'danger');
            }
        }

        async function testRestock() {
            if (!testItemId) {
                showResult('⚠️ Please create a test item first', 'warning');
                return;
            }

            try {
                showResult('Testing restock functionality...', 'info');

                const restockData = {
                    amount: 50,
                    notes: 'Test restock operation',
                    supplier: 'Test Supplier Updated',
                    costPerUnit: 6.99
                };

                const response = await window.apiClient.restockInventoryItem(testItemId, restockData);

                if (response.success) {
                    showResult(`✅ Successfully restocked item: ${response.message}`, 'success');
                    testLoadInventory(); // Refresh the table
                } else {
                    throw new Error(response.message || 'Failed to restock item');
                }

            } catch (error) {
                showResult(`❌ Error restocking item: ${error.message}`, 'danger');
            }
        }

        async function testHistory() {
            if (!testItemId) {
                showResult('⚠️ Please create a test item first', 'warning');
                return;
            }

            try {
                showResult('Loading item history...', 'info');

                const response = await window.apiClient.getInventoryItemHistory(testItemId);

                if (response.success) {
                    const { item, history, pagination } = response.data;
                    showResult(`✅ Successfully loaded history for ${item.name}: ${history.length} records (Page ${pagination.currentPage} of ${pagination.totalPages})`, 'success');

                    // Display history details
                    let historyHtml = '<h6 class="mt-3">History Records:</h6><ul class="list-group">';
                    history.forEach(record => {
                        historyHtml += `
                            <li class="list-group-item">
                                <strong>${record.action.toUpperCase()}</strong> -
                                ${new Date(record.date).toLocaleString()} -
                                ${record.previousQuantity} → ${record.newQuantity}
                                (${record.changeAmount > 0 ? '+' : ''}${record.changeAmount})
                                <br><small class="text-muted">${record.notes}</small>
                            </li>
                        `;
                    });
                    historyHtml += '</ul>';

                    document.getElementById('testResults').innerHTML += historyHtml;
                } else {
                    throw new Error(response.message || 'Failed to load history');
                }

            } catch (error) {
                showResult(`❌ Error loading history: ${error.message}`, 'danger');
            }
        }

        function showResult(message, type) {
            const resultDiv = document.getElementById('testResults');
            const alertClass = type === 'danger' ? 'alert-danger' :
                              type === 'success' ? 'alert-success' :
                              type === 'warning' ? 'alert-warning' : 'alert-info';

            resultDiv.innerHTML = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }

        function renderInventoryTable() {
            const tbody = document.getElementById('inventoryTableBody');

            if (currentInventory.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted">No inventory items found.</td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = currentInventory.map(item => {
                const status = item.quantity === 0 ? 'Out of Stock' :
                              item.quantity <= item.threshold ? 'Low Stock' : 'In Stock';
                const statusClass = item.quantity === 0 ? 'text-danger' :
                                   item.quantity <= item.threshold ? 'text-warning' : 'text-success';

                return `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.category || 'N/A'}</td>
                        <td>${item.quantity || 0}</td>
                        <td>${item.unit || 'units'}</td>
                        <td>${item.threshold || 0}</td>
                        <td><span class="${statusClass}">${status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-info me-1" onclick="testItemRestock('${item._id}')">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="btn btn-sm btn-primary me-1" onclick="testItemEdit('${item._id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-secondary me-1" onclick="testItemHistory('${item._id}')">
                                <i class="fas fa-history"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="testItemDelete('${item._id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Individual item test functions
        function testItemRestock(itemId) {
            const item = currentInventory.find(i => i._id === itemId);
            if (item && window.inventoryManager) {
                window.inventoryManager.restockItem(itemId);
            }
        }

        function testItemEdit(itemId) {
            const item = currentInventory.find(i => i._id === itemId);
            if (item && window.inventoryManager) {
                window.inventoryManager.editItem(itemId);
            }
        }

        function testItemHistory(itemId) {
            const item = currentInventory.find(i => i._id === itemId);
            if (item && window.inventoryManager) {
                window.inventoryManager.viewHistory(itemId);
            }
        }

        function testItemDelete(itemId) {
            const item = currentInventory.find(i => i._id === itemId);
            if (item && window.inventoryManager) {
                window.inventoryManager.deleteItem(itemId);
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            showResult('Test page loaded. Checking authentication...', 'info');

            // Check if user is authenticated
            const isAuth = await checkAuth();
            if (isAuth) {
                showResult('✅ Ready to test inventory management features.', 'success');
                // Auto-load inventory on successful auth
                setTimeout(() => {
                    testLoadInventory();
                }, 1000);
            } else {
                showResult('❌ Please login as admin to test inventory features.', 'warning');
            }
        });
    </script>
</body>
</html>
