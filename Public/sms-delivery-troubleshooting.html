<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMS Delivery Troubleshooting - Sarah's Short Cakes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .issue-card {
            border-left: 4px solid #dc3545;
            margin-bottom: 20px;
        }
        .solution-card {
            border-left: 4px solid #28a745;
            margin-bottom: 20px;
        }
        .check-card {
            border-left: 4px solid #007bff;
            margin-bottom: 20px;
        }
        .step-number {
            background: #007bff;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
        }
        .code-block {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1><i class="fas fa-search text-primary"></i> SMS Delivery Troubleshooting</h1>
                    <div>
                        <button class="btn btn-primary" onclick="checkTwilioLogs()">
                            <i class="fas fa-search"></i> Check Twilio Logs
                        </button>
                        <a href="/admin-settings.html" class="btn btn-success">
                            <i class="fas fa-cog"></i> SMS Settings
                        </a>
                    </div>
                </div>

                <!-- Current Issue -->
                <div class="card issue-card">
                    <div class="card-header bg-danger text-white">
                        <h3><i class="fas fa-exclamation-triangle"></i> Issue: SMS Sent Successfully But Not Received</h3>
                    </div>
                    <div class="card-body">
                        <p><strong>Symptoms:</strong></p>
                        <ul>
                            <li>✅ Admin panel shows "SMS sent successfully"</li>
                            <li>❌ No SMS received on your phone</li>
                            <li>✅ No error messages in system</li>
                            <li>✅ Twilio authentication working</li>
                        </ul>
                        <div class="alert alert-info">
                            <strong>Most Likely Cause:</strong> Phone number verification issue with Twilio trial account
                        </div>
                    </div>
                </div>

                <!-- Diagnostic Steps -->
                <div class="card check-card">
                    <div class="card-header bg-primary text-white">
                        <h3><i class="fas fa-clipboard-check"></i> Diagnostic Checklist</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h5>Phone Number Checks:</h5>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="check1">
                                    <label class="form-check-label" for="check1">
                                        Phone number includes country code (+251)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="check2">
                                    <label class="form-check-label" for="check2">
                                        No spaces or special characters
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="check3">
                                    <label class="form-check-label" for="check3">
                                        Number is verified in Twilio console
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="check4">
                                    <label class="form-check-label" for="check4">
                                        Phone can receive international SMS
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h5>Twilio Account Checks:</h5>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="check5">
                                    <label class="form-check-label" for="check5">
                                        Trial account has remaining credits
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="check6">
                                    <label class="form-check-label" for="check6">
                                        From number is a valid Twilio number
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="check7">
                                    <label class="form-check-label" for="check7">
                                        Account is not suspended
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="check8">
                                    <label class="form-check-label" for="check8">
                                        SMS capability enabled on from number
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Solution Steps -->
                <div class="card solution-card">
                    <div class="card-header bg-success text-white">
                        <h3><i class="fas fa-tools"></i> Step-by-Step Solution</h3>
                    </div>
                    <div class="card-body">
                        <h5><span class="step-number">1</span>Verify Your Phone Number in Twilio</h5>
                        <p>This is the most common cause of the issue:</p>
                        <ol>
                            <li>Go to <a href="https://console.twilio.com/us1/develop/phone-numbers/manage/verified" target="_blank">Twilio Verified Caller IDs</a></li>
                            <li>Click "Add a new number"</li>
                            <li>Enter your Ethiopian number: <code>+251906794873</code></li>
                            <li>Choose "SMS" verification method</li>
                            <li>Enter the verification code you receive</li>
                        </ol>

                        <h5><span class="step-number">2</span>Check Twilio Message Logs</h5>
                        <ol>
                            <li>Go to <a href="https://console.twilio.com/us1/monitor/logs/messages" target="_blank">Twilio Message Logs</a></li>
                            <li>Look for your recent test messages</li>
                            <li>Check the "Status" column:
                                <ul>
                                    <li><span class="badge bg-success">delivered</span> = SMS was delivered</li>
                                    <li><span class="badge bg-warning">sent</span> = SMS was sent but delivery unknown</li>
                                    <li><span class="badge bg-danger">failed</span> = SMS failed to send</li>
                                    <li><span class="badge bg-info">undelivered</span> = SMS couldn't be delivered</li>
                                </ul>
                            </li>
                        </ol>

                        <h5><span class="step-number">3</span>Test with Different Phone Number</h5>
                        <p>Try testing with a different phone number to isolate the issue:</p>
                        <div class="code-block">
                            Test Numbers to Try:<br>
                            • Your verified Twilio number (if you have one)<br>
                            • A friend's phone number<br>
                            • A different Ethiopian carrier number
                        </div>

                        <h5><span class="step-number">4</span>Check Phone Settings</h5>
                        <ul>
                            <li>Ensure SMS is not blocked on your phone</li>
                            <li>Check if international SMS is enabled</li>
                            <li>Look in spam/junk SMS folder</li>
                            <li>Try restarting your phone</li>
                        </ul>
                    </div>
                </div>

                <!-- Quick Fix Options -->
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5><i class="fas fa-phone"></i> Option 1: Verify Number</h5>
                            </div>
                            <div class="card-body">
                                <p>Add your phone number to Twilio's verified list</p>
                                <a href="https://console.twilio.com/us1/develop/phone-numbers/manage/verified" target="_blank" class="btn btn-primary">
                                    Verify Number
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h5><i class="fas fa-credit-card"></i> Option 2: Upgrade Account</h5>
                            </div>
                            <div class="card-body">
                                <p>Add credits to remove trial restrictions</p>
                                <a href="https://console.twilio.com/us1/billing" target="_blank" class="btn btn-success">
                                    Add Credits
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h5><i class="fas fa-search"></i> Option 3: Check Logs</h5>
                            </div>
                            <div class="card-body">
                                <p>Review message delivery status</p>
                                <a href="https://console.twilio.com/us1/monitor/logs/messages" target="_blank" class="btn btn-info">
                                    View Logs
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Advanced Troubleshooting -->
                <div class="card mt-4">
                    <div class="card-header bg-warning text-dark">
                        <h4><i class="fas fa-cogs"></i> Advanced Troubleshooting</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>If SMS Still Not Received:</h6>
                                <ol>
                                    <li><strong>Check carrier blocking:</strong> Some carriers block international SMS</li>
                                    <li><strong>Try different time:</strong> Network congestion can delay SMS</li>
                                    <li><strong>Contact Twilio support:</strong> They can check delivery logs</li>
                                    <li><strong>Test with local number:</strong> Try Ethiopian Telecom API</li>
                                </ol>
                            </div>
                            <div class="col-md-6">
                                <h6>Alternative Solutions:</h6>
                                <ul>
                                    <li><strong>WhatsApp Business API:</strong> More reliable in Ethiopia</li>
                                    <li><strong>Email notifications:</strong> Backup communication method</li>
                                    <li><strong>Push notifications:</strong> For mobile app users</li>
                                    <li><strong>Ethiopia Telecom SMS:</strong> Local provider option</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Test Form -->
                <div class="card mt-4">
                    <div class="card-header bg-info text-white">
                        <h4><i class="fas fa-vial"></i> Test SMS Delivery</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="testPhoneNumber" class="form-label">Test Phone Number:</label>
                                    <input type="tel" class="form-control" id="testPhoneNumber" placeholder="+251906794873">
                                    <small class="text-muted">Include country code (+251 for Ethiopia)</small>
                                </div>
                                <button class="btn btn-primary" onclick="testSmsDelivery()">
                                    <i class="fas fa-paper-plane"></i> Send Test SMS
                                </button>
                            </div>
                            <div class="col-md-6">
                                <div id="testResult" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status Display -->
                <div class="card mt-4">
                    <div class="card-header bg-secondary text-white">
                        <h4><i class="fas fa-info-circle"></i> Current SMS Configuration Status</h4>
                    </div>
                    <div class="card-body">
                        <div id="smsStatus">Loading SMS configuration status...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Load SMS status on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSmsStatus();
        });

        // Load SMS configuration status
        async function loadSmsStatus() {
            try {
                const response = await fetch('/api/settings', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    const settings = data.data;
                    const smsSettings = settings.smsSettings || {};
                    
                    document.getElementById('smsStatus').innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6>SMS Configuration:</h6>
                                <ul class="list-unstyled">
                                    <li><strong>Provider:</strong> ${smsSettings.provider || 'Not configured'}</li>
                                    <li><strong>Account SID:</strong> ${smsSettings.accountSid ? smsSettings.accountSid.substring(0, 10) + '...' : 'Not configured'}</li>
                                    <li><strong>From Number:</strong> ${smsSettings.fromNumber || 'Not configured'}</li>
                                    <li><strong>Status:</strong> <span class="badge bg-${smsSettings.provider ? 'success' : 'warning'}">${smsSettings.provider ? 'Configured' : 'Not configured'}</span></li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Notification Settings:</h6>
                                <ul class="list-unstyled">
                                    <li><strong>SMS Notifications:</strong> <span class="badge bg-${settings.smsNotifications ? 'success' : 'secondary'}">${settings.smsNotifications ? 'Enabled' : 'Disabled'}</span></li>
                                    <li><strong>New Order SMS:</strong> <span class="badge bg-${settings.newOrderAlerts ? 'success' : 'secondary'}">${settings.newOrderAlerts ? 'Enabled' : 'Disabled'}</span></li>
                                    <li><strong>Low Stock SMS:</strong> <span class="badge bg-${settings.lowStockAlerts ? 'success' : 'secondary'}">${settings.lowStockAlerts ? 'Enabled' : 'Disabled'}</span></li>
                                </ul>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('smsStatus').innerHTML = `
                    <div class="alert alert-danger">
                        Error loading SMS status: ${error.message}
                    </div>
                `;
            }
        }

        // Test SMS delivery
        async function testSmsDelivery() {
            const phoneNumber = document.getElementById('testPhoneNumber').value;
            const resultDiv = document.getElementById('testResult');
            
            if (!phoneNumber) {
                resultDiv.innerHTML = '<div class="alert alert-warning">Please enter a phone number</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="alert alert-info">Sending test SMS...</div>';
            
            try {
                const response = await fetch('/api/settings/test-sms', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify({
                        testPhone: phoneNumber
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>✅ SMS Sent Successfully!</strong><br>
                            Check your phone for the test message.<br>
                            <small>If you don't receive it, follow the troubleshooting steps above.</small>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>❌ SMS Failed:</strong> ${result.message}<br>
                            ${result.solution ? '<small>' + result.solution.steps.join('<br>') + '</small>' : ''}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        // Check Twilio logs
        function checkTwilioLogs() {
            window.open('https://console.twilio.com/us1/monitor/logs/messages', '_blank');
        }
    </script>
</body>
</html>
